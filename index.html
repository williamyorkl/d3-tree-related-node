<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title></title>
    <script src="./d3.js"></script>
    <script src="./parseToMergeNode.js"></script>
    <style></style>
  </head>

  <body>
    <div>
      <h3>ä¸šåŠ¡é€»è¾‘</h3>
      <div>Bå¶å­èŠ‚ç‚¹å’ŒCå¶å­èŠ‚ç‚¹æœ‰ç›¸åŒçš„èŠ‚ç‚¹ï¼Œéœ€è¦åˆå¹¶ä»–ä»¬</div>
    </div>
    <svg class="chart"></svg>

    <script>
      const data = {
        name: "root",
        children: [
          {
            name: "äºŒçº§èŠ‚ç‚¹1",
            children: [
              {
                name: "A",
                value: "å¶å­èŠ‚ç‚¹",
                children: [
                  {
                    name: "lucy",
                    value: "same_root",
                    mergeId: "223344",
                  },
                ],
              },
              {
                name: "B",
                value: "å¶å­èŠ‚ç‚¹",
                children: [
                  {
                    name: "kevin",
                    value: "same_root",
                    mergeId: "556677",
                  },
                ],
              },
              {
                name: "C",
                value: "å¶å­èŠ‚ç‚¹",
              },
            ],
          },
          {
            name: "äºŒçº§èŠ‚ç‚¹2",
            children: [
              {
                name: "C",
                value: "å¶å­èŠ‚ç‚¹",
              },
              {
                name: "C",
                value: "å¶å­èŠ‚ç‚¹",
                children: [
                  {
                    name: "lucy",
                    value: "same_root",
                    mergeId: "223344",
                  },
                ],
              },
              {
                name: "C",
                value: "å¶å­èŠ‚ç‚¹",
                children: [
                  {
                    name: "kevin",
                    value: "same_root",
                    mergeId: "556677",
                  },
                ],
              },
              {
                name: "D",
                value: "å¶å­èŠ‚ç‚¹",
              },
            ],
          },
        ],
      };

      const width = 1366;
      const height = 580;

      const svg = d3
        .select(".chart")
        .attr("width", width)
        .attr("height", height);

      /** åœ¨<svg>ä¸‹æ–°å¢äº†ä¸€ä¸ªgèŠ‚ç‚¹ */
      const g = svg.append("g").attr("transform", "translate(40, 20)");

      /**
       * å°†æ•°æ®ç»“æ„åŒ–, è¿”å›åçš„nodeèŠ‚ç‚¹åŠå…¶åä»£å‡æœ‰å¦‚ä¸‹å±æ€§
       *    node.data,
       *    node.depth,
       *    node.height,
       *    node.parent,
       *    node.children,
       *    node.value
       */
      const hierarchyData = d3.hierarchy(data);
      console.log("â€”â€”â€”â€”â€”â€”d3.hierarchy(data)â€”â€”â€”â€”â€”â€”");
      console.log(hierarchyData);

      //d3.tree()è¿”å›tree layout,åç»­é“¾å¼å†™æ³•å¯¹layoutè¿›è¡Œé…ç½®
      const treeLayout = d3
        .tree()
        .size([width, height - 30])
        .separation((a, b) => {
          return a.parent === b.parent ? 1 : 2;
        });
      console.log("â€”â€”â€”â€”â€”â€”treeLayoutâ€”â€”â€”â€”â€”â€”");
      console.log(treeLayout);

      //å°†æ•°æ®æ‰”è¿›layout,è·å–æ›´æ˜“äºå¸ƒå±€çš„æ•°æ®nodesData, ç›¸å¯¹hierarchyData, æ‰€æœ‰æ•°æ®åŠ ä¸Šäº†.x,.yå±/

      const nodesData = treeLayout(hierarchyData);
      console.log("â€”â€”â€”â€”â€”â€”nodesDataâ€”â€”â€”â€”â€”â€”");
      console.log(nodesData);

      const needToMergeNodesObj = parseNeedToMergeTree(nodesData);

      // const totalWidth = calculateNodesWidth(nodesData);

      const centerX = centerNodeX(nodesData);

      const res = handleNodePosition(needToMergeNodesObj, centerX);

      console.log("ğŸš€ ~ file: index.html ~ line 132 ~ res", res);

      console.log("â€”â€”â€”â€”â€”â€”èŠ‚ç‚¹å±•å¼€ï¼Œç”±äºæ˜¯ç”»linkï¼Œæ‰€ä»¥å»é™¤rootèŠ‚ç‚¹");
      const links = g
        .selectAll(".links")
        .data(nodesData.descendants().slice(1))
        .enter()
        .append("path")
        .attr("fill", "none")
        .attr("stroke", "#313131")
        .attr("stroke-width", 2)
        .attr("d", (d) => {
          return `
                M${d.x},${d.y}
                C${d.x},${(d.y + d.parent.y) / 2}
                ${d.parent.x},${(d.y + d.parent.y) / 2.5}
                ${d.parent.x},${d.parent.y}`;
        });

      const nodes = g
        .selectAll(".node")
        .data(nodesData.descendants())
        .enter()
        .append("g")
        .attr("transform", (d) => {
          return `translate(${d.x}, ${d.y})`;
        });

      /**
       * ç”»èŠ‚ç‚¹çš„å›¾
       *  1. ç”»åœ†åœˆ
       *  2. åŠ æ–‡å­—
       */

      // 1. ç”»åœ†
      nodes.append("circle").style("fill", "#c03027").attr("r", 10);

      //2. æ’å…¥æ–‡å­—
      nodes
        .append("text")
        .attr("dx", ".9em")
        .text((d) => {
          return d.data.name;
        });
    </script>
  </body>
</html>
